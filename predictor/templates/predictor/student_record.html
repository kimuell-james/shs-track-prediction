{% extends 'predictor/main.html' %}

{% load static %}

{% block content %}

<h1>ðŸ“‹ Student Record</h1>
<hr>

<div>
    {% if current_sy %}
    <h3>Students for School Year {{ current_sy.school_year }}</h3>
    {% else %}
    <h3>No active school year set</h3>
    {% endif %}
    <div class="row mb-3">
        <div class="col-md-2">
            <a href="{% url 'add_record' %}" type="button" class="btn btn-success">
                + Add Student
             </a>
        </div>
    </div>
    
</div>

<div class="d-flex gap-2 align-items-center mb-3 flex-wrap">
    <select id="filterAge" class="form-select" style="width:150px;">
        <option value="">All Ages</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18</option>
    </select>

  <select id="filterGender" class="form-select" style="width:150px;">
    <option value="">All Genders</option>
    <option value="Male">Male</option>
    <option value="Female">Female</option>
  </select>

  <select id="filterGrade" class="form-select" style="width:150px;">
    <option value="">All Grades</option>
    <option value="10">10</option>
    <option value="11">11</option>
    <option value="12">12</option>
  </select>

  <select id="filterPredictedTrack" class="form-select" style="width:180px;">
    <option value="">All Predicted Tracks</option>
    <option value="Academic">Academic</option>
    <option value="TVL">TVL</option>
  </select>

  <select id="filterActualTrack" class="form-select" style="width:180px;">
    <option value="">All Actual Tracks</option>
    <option value="Academic">Academic</option>
    <option value="TVL">TVL</option>
  </select>

  <button id="clearFilters" class="btn btn-danger">
    Clear All Filters
  </button>
</div>


<div>
    <table id="studentTable" class="table table-striped table-hover text-center">
        <thead>
            <tr>
                <th>ID</th>
                <th>Age</th>
                <th>Gender</th>
                <th>Grade Level</th>
                <th>School year</th>
                <th>Predicted Track</th>
                <th>Actual Track</th>
                <th>Contributing Subject</th>
                <th>Predict Track</th>
                <th>View</th>
                <th>Update</th>
                {% if user.is_superuser %}
                <th>Delete</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            <tr>
                <td>{{record.student_id}}</td>
                <td>{{record.age}}</td>
                <td>{{record.gender}}</td>
                <td>{{record.grade_level}}</td>
                <td>{{record.sy}}</td>
                <td>{{ record.predicted_track|default:"â€”" }}</td>
                <td>{{record.actual_track}}</td>
                <td>{{ record.contributing_subjects|default:"â€”" }}</td>
                <td id="student-{{ record.student_id }}">
                    <a href="{% url 'predict_track' record.student_id %}?page={{ page_obj.number }}#student-{{ record.student_id }}"
                        class="btn btn-success">
                        Predict
                    </a>
                </td>
                <td>
                    <a href="{% url 'view_record' record.student_id %}" class="btn btn-primary">View</a>
                </td>
                <td>
                    <a href="{% url 'update_record' record.student_id %}" class="btn btn-warning">Update</a>
                </td>
                {% if user.is_superuser %}
                <td><!-- Delete button triggers modal -->
                    <button type="button" class="btn btn-danger deleteBtn" data-bs-toggle="modal"
                        data-bs-target="#deleteConfirmModal" data-url="{% url 'delete_record' record.student_id %}">
                        Delete
                    </button>
                </td>
                {% endif %}

            </tr>
            {% empty %}
            <tr>
                <td colspan="5">No students found for this school year.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const table = new DataTable('#studentTable');

    // Common filter function
    function applyExactFilter(columnIndex, value) {
        table.column(columnIndex)
            .search(value ? '^' + value + '$' : '', true, false)
            .draw();
    }

    // Filter by Age
    document.getElementById('filterAge').addEventListener('change', function () {
        applyExactFilter(1, this.value);
    });

    // Filter by Gender
    document.getElementById('filterGender').addEventListener('change', function () {
        applyExactFilter(2, this.value);
    });

    // Filter by Grade Level
    document.getElementById('filterGrade').addEventListener('change', function () {
        applyExactFilter(3, this.value);
    });

    // Filter by Predicted Track
    document.getElementById('filterPredictedTrack').addEventListener('change', function () {
        applyExactFilter(5, this.value);
    });

    // Filter by Actual Track
    document.getElementById('filterActualTrack').addEventListener('change', function () {
        applyExactFilter(6, this.value);
    });

    // âœ… Clear All Filters
    document.getElementById('clearFilters').addEventListener('click', function () {
        // Reset dropdowns
        document.getElementById('filterAge').value = '';
        document.getElementById('filterGender').value = '';
        document.getElementById('filterGrade').value = '';
        document.getElementById('filterPredictedTrack').value = '';
        document.getElementById('filterActualTrack').value = '';

        // Clear DataTable searches
        table.columns().search('').draw();
    });
});
</script>
{% endblock %}
